name: ðŸš€ Release Please

on:
    schedule:
        - cron: "0 12 * * 5"
    workflow_dispatch:
permissions:
    contents: write
    pull-requests: write

jobs:
    release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  ref: master

            - name: Check for changes on master in the last 7 days
              id: changes
              run: |
                  git fetch origin master --prune
                  if git log origin/master --since="7 days ago" --oneline | grep .; then
                    echo "changed=true" >> $GITHUB_OUTPUT
                  else
                    echo "changed=false" >> $GITHUB_OUTPUT
                  fi

            - name: ðŸ¤– Release Please
              if: steps.changes.outputs.changed == 'true'
              id: rp
              uses: googleapis/release-please-action@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  config-file: release-please-config.json
                  manifest-file: .release-please-manifest.json
                  target-branch: master

            - name: âœ… Mark release PR as published
              if: ${{ steps.changes.outputs.changed == 'true' && steps.rp.outputs.release_created }}
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const tag = `${{ steps.rp.outputs.tag_name }}`;

                      const prs = await github.paginate(github.rest.pulls.list, {
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        state: "closed",
                        per_page: 50
                      });

                      const pr = prs.find(p =>
                        p.merged_at &&
                        (p.user?.login === "release-please[bot]" || p.user?.login === "github-actions[bot]") &&
                        (p.labels || []).some(l => (l.name || "").startsWith("autorelease:"))
                      );

                      if (!pr) return;

                      await github.rest.issues.addLabels({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: pr.number,
                        labels: ["autorelease: published"]
                      });

                      await github.rest.issues.createComment({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        issue_number: pr.number,
                        body: `âœ… Released in **${tag}** ðŸŽ‰`
                      });
